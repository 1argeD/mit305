<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/order.css">
    <title>발주서 발행</title>
</head>
<body>
    <div class="container">
        <table>
            <thead>
                <tr>
                    <td style="text-align:center; background-color: #ccc;">업체명</td>
                    <td colspan="6" style="text-align:left; background-color: #fff;">
                        <form th:action="@{/orderRegister}" method="get">
                            <select id="departName" name="departName" th:onchange="this.form.submit()">
                                <option value="" disabled selected>선택</option>
                                <option th:each="orderDto : ${oList}" th:value="${orderDto.departName}" th:text="${orderDto.departName}">
                                </option>
                            </select>
                        </form>
                    </td>
                </tr>
                <tr>
                    <th>품목명</th>
                    <th>품목코드</th>
                    <th>조달 수량</th>
                    <th>현재 재고량</th>
                    <th>제품 생산 예정 날짜</th>
                    <th>물품 발주일</th>
                    <th>L/T</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="order : ${#strings.isEmpty(param.departName) ? oList : oList.?[departName==param.departName]}">
                    <td th:text="${order.product_name}"></td>
                    <td th:text="${order.product_code}"></td>
                    <td th:text="${order.supportProductAmount}"></td>
                    <td>현재 재고량들</td>
                    <td th:text="${#temporals.format(order.projectOutputDate, 'yyyy-MM-dd')}"></td>
                    <td th:text="${#temporals.format(order.order_date, 'yyyy-MM-dd')}"></td>
                    <td th:text="${order.lead_time}"></td>
                    <td><button th:attr="onclick='cancel(this, \'' + ${order.product_code} + '\')'">취소</button></td>
                </tr>
            </tbody>
            <tr>
                <td style="text-align:center; background-color: #ccc;">이메일</td>
                <td colspan="6" style="text-align:left;">abcde@gmail.com</td>
            </tr>
        </table>
    </div>
    <div class="btn-container">
        <button id="registerBtn" class="btn btn-primary" onclick="orderReg()" disabled>발행</button>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function(){
            $.ajax({
                url: '/api/orderRegister/count',
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    var regBtn = document.getElementById("registerBtn");
                    if(data > 0)
                        regBtn.disabled = false;
                    else
                        regBtn.disabled = true;
                },
                error: function(error) {
                    console.error('오류:', error);
                }
            });

            function cancel(btn, pcode){
                var confirmCancel = confirm("취소하시겠습니까?");
                if(confirmCancel){
                    $.ajax({
                        url: '/api/cancelOrder/' + pcode,
                        method: 'DELETE',
                        success: function(data) {
                            alert('취소되었습니다.');
                            $('#row_' + pcode).remove();
                            location.reload();
                        },
                        error: function(error) {
                            console.error('취소 오류:', error);
                        }
                    });
                }
            }

            function orderReg(){
                var result = confirm("발주서를 등록하시겠습니까?");
                if(result){
                    alert("발주서가 발행되었습니다.");
                    window.location.href = 'StatusManagementReport';
                } else {
                    window.close();
                }
            }
        });
    </script>
</body>
</html>
